<template>
    <div class="dashboard-container">
        <!-- Dashboard Header -->
        <div class="slds-page-header slds-page-header_record-home">
            <div class="slds-page-header__row">
                <div class="slds-page-header__col-title">
                    <div class="slds-media card-content">
                        <div class="slds-media__figure">
                            <lightning-icon icon-name="standard:account" size="large"></lightning-icon>
                        </div>
                        <div class="slds-media__body">
                            <div class="slds-page-header__name">
                                <div class="slds-page-header__name-title">
                                    <h1>
                                        <span class="slds-page-header__title slds-truncate" title={dashboardTitle}>
                                            {dashboardTitle}
                                        </span>
                                    </h1>
                                </div>
                            </div>
                            <p class="slds-page-header__name-meta">Welcome back, {accountName}</p>
                        </div>
                    </div>
                </div>
                <div class="slds-page-header__col-actions">
                    <div class="slds-page-header__controls">
                        
                        <template if:true={isLoggedInUser}>
                        <lightning-button 
                            label="View Credit Score" 
                            variant="neutral" 
                            onclick={handleViewCreditScore}
                            icon-name="utility:trending"
                            class="slds-m-left_x-small">
                        </lightning-button>
                        <lightning-button 
                            label="Update Profile" 
                            variant="neutral" 
                            onclick={handleViewFullProfile}
                            icon-name="utility:user"
                            class="slds-m-left_x-small">
                        </lightning-button>
                        <lightning-button 
                            label="View Billing" 
                            variant="neutral" 
                            data-tab="billing"
                            onclick={handleTabClick}
                            icon-name="utility:money"
                            class="slds-m-left_x-small">
                        </lightning-button>
                        <lightning-button 
                            label="Get Support" 
                            variant="neutral" 
                            onclick={handleNavigateToSupport}
                            icon-name="utility:help"
                            class="slds-m-left_x-small">
                        </lightning-button>
                        <lightning-button 
                            label="Request New Score" 
                            variant="brand" 
                            onclick={handleNavigateToRequestScore}
                            icon-name="utility:add"
                            class="slds-m-left_x-small">
                        </lightning-button>
                            <lightning-button 
                                label="Logout" 
                                variant="destructive" 
                                onclick={handleLogout}
                                icon-name="utility:logout"
                                class="slds-m-left_x-small">
                            </lightning-button>
                        </template>
                        <template if:false={isLoggedInUser}>
                            <lightning-button 
                                label="Login" 
                                variant="brand" 
                                onclick={handleLogin}
                                icon-name="utility:user"
                                class="slds-m-left_x-small">
                            </lightning-button>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats Cards -->
        <div class="slds-grid slds-gutters slds-wrap slds-m-top_large">
            <!-- Credit Score Card -->
            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                <div class="slds-box slds-box_small stats-card">
                    <div class="slds-media">
                        <div class="slds-media__figure">
                            <lightning-icon icon-name="utility:trending" size="medium" variant="inverse" class="score-icon"></lightning-icon>
                        </div>
                        <div class="slds-media__body">
                            <h3 class="slds-text-heading_small">Current Credit Score</h3>
                            <template if:true={hasCurrentScore}>
                                <p class="slds-text-heading_large slds-text-color_success">{currentScore}</p>
                                <p class="slds-text-body_small slds-text-color_weak">Last updated: {lastCalculationDate}</p>
                            </template>
                            <template if:false={hasCurrentScore}>
                                <p class="slds-text-body_regular slds-text-color_weak">No score available</p>
                                <lightning-button label="Calculate Score" variant="neutral" size="small" onclick={handleRequestCreditScore}></lightning-button>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Completion Card -->
            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                <div class="slds-box slds-box_small stats-card">
                    <div class="slds-media">
                        <div class="slds-media__figure">
                            <lightning-icon icon-name="utility:user" size="medium" variant="inverse" class="profile-icon"></lightning-icon>
                        </div>
                        <div class="slds-media__body">
                            <h3 class="slds-text-heading_small">Profile Completion</h3>
                            <p class="slds-text-heading_large">{profileCompletionPercentage}%</p>
                            <div class="slds-progress-bar slds-progress-bar_small slds-m-top_x-small">
                                <span class={profileCompletionClass}>
                                    <span class="slds-assistive-text">Progress: {profileCompletionPercentage}%</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Billing Status Card -->
            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                <div class="slds-box slds-box_small stats-card">
                    <div class="slds-media">
                        <div class="slds-media__figure">
                            <lightning-icon icon-name="utility:money" size="medium" variant="inverse" class="billing-icon"></lightning-icon>
                        </div>
                        <div class="slds-media__body">
                            <h3 class="slds-text-heading_small">Billing History</h3>
                            <template if:true={hasBillingHistory}>
                                <p class="slds-text-heading_large">{billingHistory.length}</p>
                                <p class="slds-text-body_small slds-text-color_weak">Total records</p>
                            </template>
                            <template if:false={hasBillingHistory}>
                                <p class="slds-text-body_regular slds-text-color_weak">No billing history</p>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Tabs -->
        <div class="slds-tabs_default slds-m-top_large">
            <ul class="slds-tabs_default__nav" role="tablist">
                <li class={tabClasses.overview} title="Overview" role="presentation">
                    <a class="slds-tabs_default__link" href="#" role="tab" data-tab="overview" onclick={handleTabClick}>Overview</a>
                </li>
                <li class={tabClasses.billing} title="Billing History" role="presentation">
                    <a class="slds-tabs_default__link" href="#" role="tab" data-tab="billing" onclick={handleTabClick}>Billing History</a>
                </li>
                <li class={tabClasses.requests} title="Requests" role="presentation">
                    <a class="slds-tabs_default__link" href="#" role="tab" data-tab="requests" onclick={handleTabClick}>Requests</a>
                </li>
            </ul>

            <!-- Overview Tab Content -->
            <template if:true={isOverviewTab}>
                <div class="slds-tabs_default__content" role="tabpanel">
                    <!-- Credit Score Display - Full Width -->
                    <c-credit-score-display 
                        record-id={recordId}
                        show-history="true"
                        card-title="My Credit Score">
                    </c-credit-score-display>
                </div>
            </template>


            <!-- Billing History Tab Content -->
            <template if:true={isBillingTab}>
                <div class="slds-tabs_default__content" role="tabpanel">
                    <lightning-card title="Billing History" icon-name="utility:money">
                        <div class="slds-p-around_medium">
                            <template if:true={hasBillingHistory}>
                                <div class="slds-scrollable_x">
                                    <table class="slds-table slds-table_cell-buffer slds-table_bordered">
                                        <thead>
                                            <tr class="slds-line-height_reset">
                                                <th class="" scope="col">
                                                    <div class="slds-truncate" title="Bill ID">Bill ID</div>
                                                </th>
                                                <th class="" scope="col">
                                                    <div class="slds-truncate" title="Amount">Amount</div>
                                                </th>
                                                <th class="" scope="col">
                                                    <div class="slds-truncate" title="Due Date">Due Date</div>
                                                </th>
                                                <th class="" scope="col">
                                                    <div class="slds-truncate" title="Payment Date">Payment Date</div>
                                                </th>
                                                <th class="" scope="col">
                                                    <div class="slds-truncate" title="Status">Status</div>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template for:each={billingHistory} for:item="bill">
                                                <tr key={bill.Id} class="slds-hint-parent">
                                                    <td data-label="Bill ID">
                                                        <div class="slds-truncate" title={bill.Billing_ID__c}>
                                                            <a href="#" data-id={bill.Id} onclick={handleViewBillingDetails}>
                                                                {bill.Billing_ID__c}
                                                            </a>
                                                        </div>
                                                    </td>
                                                    <td data-label="Amount">
                                                        <div class="slds-truncate" title={bill.formattedAmount}>{bill.formattedAmount}</div>
                                                    </td>
                                                    <td data-label="Due Date">
                                                        <div class="slds-truncate" title={bill.formattedDueDate}>{bill.formattedDueDate}</div>
                                                    </td>
                                                    <td data-label="Payment Date">
                                                        <div class="slds-truncate" title={bill.formattedPaymentDate}>{bill.formattedPaymentDate}</div>
                                                    </td>
                                                    <td data-label="Status">
                                                        <span class={bill.statusClass}>{bill.Payment_Status__c}</span>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </template>
                            <template if:false={hasBillingHistory}>
                                <div class="slds-align_absolute-center slds-p-around_large">
                                    <div class="slds-text-align_center">
                                        <lightning-icon icon-name="utility:info" size="large" variant="warning"></lightning-icon>
                                        <h3 class="slds-text-heading_medium slds-m-top_small">No Billing History</h3>
                                        <p class="slds-text-body_regular slds-m-top_small">
                                            No billing records found for your account.
                                        </p>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </lightning-card>
                </div>
            </template>

            <!-- Requests Tab Content -->
            <template if:true={isRequestsTab}>
                <div class="slds-tabs_default__content" role="tabpanel">
                    <lightning-card title="Credit Score Requests" icon-name="utility:task">
                        <div class="slds-p-around_medium">
                            <template if:true={hasRequests}>
                                <div class="slds-scrollable_x">
                                    <table class="slds-table slds-table_cell-buffer slds-table_bordered">
                                        <thead>
                                            <tr class="slds-line-height_reset">
                                                <th class="" scope="col">
                                                    <div class="slds-truncate" title="Request Date">Request Date</div>
                                                </th>
                                                <th class="" scope="col">
                                                    <div class="slds-truncate" title="Channel">Channel</div>
                                                </th>
                                                <th class="" scope="col">
                                                    <div class="slds-truncate" title="Status">Status</div>
                                                </th>
                                                <th class="" scope="col">
                                                    <div class="slds-truncate" title="Completed Date">Completed Date</div>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template for:each={creditScoreRequests} for:item="request">
                                                <tr key={request.Id} class="slds-hint-parent">
                                                    <td data-label="Request Date">
                                                        <div class="slds-truncate" title={request.formattedRequestDate}>{request.formattedRequestDate}</div>
                                                    </td>
                                                    <td data-label="Channel">
                                                        <div class="slds-truncate" title={request.Request_Channel__c}>{request.Request_Channel__c}</div>
                                                    </td>
                                                    <td data-label="Status">
                                                        <span class={request.statusClass}>{request.Request_Status__c}</span>
                                                    </td>
                                                    <td data-label="Completed Date">
                                                        <div class="slds-truncate" title={request.formattedCompletedDate}>{request.formattedCompletedDate}</div>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </template>
                            <template if:false={hasRequests}>
                                <div class="slds-align_absolute-center slds-p-around_large">
                                    <div class="slds-text-align_center">
                                        <lightning-icon icon-name="utility:info" size="large" variant="warning"></lightning-icon>
                                        <h3 class="slds-text-heading_medium slds-m-top_small">No Requests</h3>
                                        <p class="slds-text-body_regular slds-m-top_small">
                                            You haven't made any credit score requests yet.
                                        </p>
                                        <lightning-button 
                                            label="Request Credit Score" 
                                            variant="brand" 
                                            onclick={handleRequestCreditScore}
                                            disabled={isRequestingScore}
                                            class="slds-m-top_medium">
                                        </lightning-button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </lightning-card>
                </div>
            </template>
        </div>
    </div>
</template>
